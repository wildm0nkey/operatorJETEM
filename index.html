<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>JETEM express — Панель приёма заказов</title>
  <style>
    :root{--blue:#0b69d6;--white:#ffffff;--muted: #e6eefc}
    body{margin:0;font-family:Inter, Arial, sans-serif;background:#f6f8fb;color:#0b1733}
    header{background:var(--blue);color:var(--white);padding:14px 16px;display:flex;align-items:center;justify-content:space-between}
    header h1{margin:0;font-size:18px}
    header .support{font-size:14px;opacity:0.95}
    .wrap{display:flex;gap:16px;padding:16px}
    .sidebar{width:260px;background:white;border-radius:10px;padding:12px;box-shadow:0 4px 18px rgba(11,105,214,0.08)}
    .main{flex:1;background:white;border-radius:10px;padding:12px;box-shadow:0 4px 18px rgba(11,105,214,0.06)}
    .tabs{display:flex;gap:8px}
    .tab{padding:8px 10px;border-radius:8px;background:var(--muted);cursor:pointer}
    .search{margin-top:12px}
    input[type=text]{width:100%;padding:8px;border-radius:8px;border:1px solid #e3e9f5}
    .order{border:1px solid #eef4ff;padding:10px;border-radius:8px;margin-bottom:10px;display:flex;justify-content:space-between;gap:8px}
    .order .left{flex:1}
    .order .right{display:flex;flex-direction:column;gap:6px;align-items:flex-end}
    .btn{padding:8px 10px;border-radius:8px;border:0;background:var(--blue);color:var(--white);cursor:pointer}
    .btn.secondary{background:#f3f6fb;color:#0b69d6;border:1px solid #dbe9ff}
    .status{padding:6px 8px;border-radius:6px;font-size:13px}
    .s-new{background:#fff6e6;color:#9a6a00}
    .s-accepted{background:#eef9f2;color:#167a3b}
    .s-inprogress{background:#eef4ff;color:#0b69d6}
    .s-completed{background:#f0fff4;color:#0e9d3f}
    .s-cancelled{background:#fff0f3;color:#a10b3a}
    .details{margin-top:8px;border-top:1px dashed #eef4ff;padding-top:8px}
    .photo{max-width:120px;border-radius:6px}
    /* login overlay */
    #loginOverlay{position:fixed;inset:0;background:rgba(11,105,214,0.08);display:flex;align-items:center;justify-content:center}
    #loginCard{background:white;padding:20px;border-radius:12px;width:360px;box-shadow:0 8px 30px rgba(11,105,214,0.12)}
    #loginCard h2{margin:0 0 6px 0}
    #loginCard input{width:100%;padding:8px;border-radius:8px;border:1px solid #e6eefc;margin-top:8px}
    .small{font-size:13px;color:#6b7280}
    @media(max-width:900px){.wrap{flex-direction:column}.sidebar{width:100%}}
  </style>
</head>
<body>
  <header>
    <h1>JETEM express — Панель приёма заказов</h1>
    <div class="support">Служба поддержки: <strong>+7 747 352 2909</strong></div>
  </header>

  <div class="wrap">
    <div class="sidebar">
      <div class="tabs">
        <div class="tab" data-filter="all">Все</div>
        <div class="tab" data-filter="new">Новые</div>
        <div class="tab" data-filter="accepted">Принятые</div>
        <div class="tab" data-filter="inprogress">В процессе</div>
        <div class="tab" data-filter="completed">Завершённые</div>
        <div class="tab" data-filter="cancelled">Отменённые</div>
      </div>
      <div class="search"><input id="q" type="text" placeholder="Поиск по телефону или адресу" /></div>
      <div style="margin-top:12px"><button id="refreshBtn" class="btn secondary">Обновить</button> <button id="clearBtn" class="btn" style="margin-left:6px">Удалить всё (тест)</button></div>
      <div class="small" style="margin-top:10px">Здесь отображаются заказы, которые приходят с клиентского сайта. Для начала разработки используется локальный API-заглушка, позже подключим PHP + MySQL.</div>
    </div>

    <div class="main">
      <h3 id="heading">Заказы</h3>
      <div id="ordersContainer"></div>
    </div>
  </div>

  <!-- Login overlay (password gate) -->
  <div id="loginOverlay">
    <div id="loginCard">
      <h2>Вход в панель JETEM</h2>
      <div class="small">Введите пароль, чтобы продолжить</div>
      <input id="passInput" type="password" placeholder="Пароль" />
      <div style="display:flex;gap:8px;margin-top:12px">
        <button id="loginBtn" class="btn">Войти</button>
        <button id="demoBtn" class="btn secondary">Demo (локально)</button>
      </div>
      <div id="loginMsg" class="small" style="margin-top:10px;color:#a10b3a;display:none"></div>
    </div>
  </div>

  <script>
    // Конфигурация
    const ADMIN_PASSWORD = '22333';
    const API_BASE = '/api/orders.php'; // ожидаемый бекенд (PHP)

    // Простая авторизация: проверяем пароль и сохраняем флаг в sessionStorage
    const overlay = document.getElementById('loginOverlay');
    const loginMsg = document.getElementById('loginMsg');
    document.getElementById('loginBtn').addEventListener('click', ()=>{
      const v = document.getElementById('passInput').value.trim();
      if(v===ADMIN_PASSWORD){sessionStorage.setItem('jetem_admin_auth','1'); overlay.style.display='none'; loadOrders();}
      else{loginMsg.style.display='block'; loginMsg.textContent='Неверный пароль';}
    });
    document.getElementById('demoBtn').addEventListener('click', ()=>{sessionStorage.setItem('jetem_admin_auth','1'); overlay.style.display='none'; loadOrders(true)});

    if(sessionStorage.getItem('jetem_admin_auth')==='1'){overlay.style.display='none'; loadOrders();}

    // UI handling
    let orders = [];
    let currentFilter = 'all';

    document.querySelectorAll('.tab').forEach(t=>t.addEventListener('click', (e)=>{ currentFilter = e.target.dataset.filter; renderOrders(); }));
    document.getElementById('refreshBtn').addEventListener('click', ()=>loadOrders());
    document.getElementById('clearBtn').addEventListener('click', ()=>{ if(confirm('Удалить все заказы из localStorage?')){localStorage.removeItem('jetem_admin_orders'); loadOrders(true)} });
    document.getElementById('q').addEventListener('input', renderOrders);

    // Загрузить заказы: сначала пробуем API, если не доступен — используем localStorage (mock)
    async function loadOrders(forceLocal=false){
      if(!forceLocal){
        try{
          const res = await fetch(API_BASE + '?action=list');
          if(res.ok){
            const data = await res.json(); if(data && Array.isArray(data)) { orders = data; renderOrders(); return; }
          }
        }catch(e){console.warn('API недоступен, используем локальные данные', e)}
      }
      // fallback: localStorage
      orders = JSON.parse(localStorage.getItem('jetem_admin_orders')||'[]');
      // если пусто, добавим демо
      if(orders.length===0){
        const now = Date.now();
        orders = [
          {id: now+1, from_address:'ул. Демонстрационная 1', from_house:'12', from_apt:'5', from_floor:2, to_address:'ул. Получатель 2', to_house:'3', to_apt:'12', to_floor:1, phone:'+7 701 000 0000', photo_paths:[], distance_km:3.2, price_tenge:Math.ceil(3.2)*600, status:'new', created_at:new Date().toISOString()},
          {id: now+2, from_address:'ул. Пример A', from_house:'4', from_apt:'2', from_floor:1, to_address:'ул. Пример B', to_house:'9', to_apt:'7', to_floor:1, phone:'+7 700 111 2222', photo_paths:[], distance_km:1.1, price_tenge:600, status:'accepted', created_at:new Date().toISOString()}
        ];
        localStorage.setItem('jetem_admin_orders', JSON.stringify(orders));
      }
      renderOrders();
    }

    function renderOrders(){
      const cont = document.getElementById('ordersContainer'); cont.innerHTML='';
      const q = document.getElementById('q').value.trim().toLowerCase();
      const filtered = orders.filter(o=>{
        if(currentFilter!=='all' && o.status!==currentFilter) return false;
        if(q==='') return true;
        return (o.phone||'').toLowerCase().includes(q) || (o.from_address||'').toLowerCase().includes(q) || (o.to_address||'').toLowerCase().includes(q);
      });
      if(filtered.length===0){ cont.innerHTML='<div class="small">Нет заказов</div>'; return }
      filtered.forEach(o=>{
        const el = document.createElement('div'); el.className='order';
        const left = document.createElement('div'); left.className='left';
        left.innerHTML = `<div><strong>${o.phone||'—'}</strong> — ${o.price_tenge || '—'} ₸</div><div class="small">${o.from_address} → ${o.to_address}</div>`;
        const right = document.createElement('div'); right.className='right';
        const s = document.createElement('div'); s.className='status ' + statusClass(o.status); s.textContent = statusLabel(o.status);
        const more = document.createElement('button'); more.className='btn secondary'; more.textContent='Детали'; more.onclick=()=>showDetails(o);
        const actions = document.createElement('div'); actions.style.display='flex'; actions.style.gap='6px';
        const accept = document.createElement('button'); accept.className='btn'; accept.textContent='Принять'; accept.onclick=()=>updateStatus(o,'accepted');
        const take = document.createElement('button'); take.className='btn'; take.textContent='В путь'; take.onclick=()=>updateStatus(o,'inprogress');
        const complete = document.createElement('button'); complete.className='btn'; complete.textContent='Завершить'; complete.onclick=()=>updateStatus(o,'completed');
        const cancel = document.createElement('button'); cancel.className='btn secondary'; cancel.textContent='Отменить'; cancel.onclick=()=>updateStatus(o,'cancelled');
        actions.appendChild(accept); actions.appendChild(take); actions.appendChild(complete); actions.appendChild(cancel);
        right.appendChild(s); right.appendChild(more); right.appendChild(actions);
        el.appendChild(left); el.appendChild(right);
        cont.appendChild(el);
      });
    }

    function statusClass(st){ if(st==='new') return 's-new'; if(st==='accepted') return 's-accepted'; if(st==='inprogress') return 's-inprogress'; if(st==='completed') return 's-completed'; if(st==='cancelled') return 's-cancelled'; return '' }
    function statusLabel(st){ if(st==='new') return 'Новый'; if(st==='accepted') return 'Принят'; if(st==='inprogress') return 'В пути'; if(st==='completed') return 'Доставлен'; if(st==='cancelled') return 'Отменён'; return st }

    function showDetails(o){
      const w = window.open('', '_blank');
      const html = `<!doctype html><html><head><meta charset="utf-8"><title>Заказ ${o.id}</title><style>body{font-family:Arial;padding:12px} .photo{max-width:320px}</style></head><body><h2>Заказ ${o.id}</h2><div><strong>Тел:</strong> ${o.phone||'—'}</div><div><strong>Цена:</strong> ${o.price_tenge||'—'} ₸</div><h3>От</h3><div>${o.from_address} (дом ${o.from_house||''}, кв ${o.from_apt||''}, эт ${o.from_floor||''})</div><h3>До</h3><div>${o.to_address} (дом ${o.to_house||''}, кв ${o.to_apt||''}, эт ${o.to_floor||''})</div><h3>Фото</h3>${(o.photo_paths && o.photo_paths.length>0)? o.photo_paths.map(p=>`<img class="photo" src="${p}"/>`).join('') : '<div>Фото не приложено</div>'}<h3>Действия</h3><div><button onclick="window.opener.postMessage({cmd:'update',id:${o.id},status:'accepted'},'*')">Принять</button> <button onclick="window.opener.postMessage({cmd:'update',id:${o.id},status:'inprogress'},'*')">В путь</button> <button onclick="window.opener.postMessage({cmd:'update',id:${o.id},status:'completed'},'*')">Завершить</button> <button onclick="window.opener.postMessage({cmd:'update',id:${o.id},status:'cancelled'},'*')">Отменить</button></div></body></html>`;
      w.document.write(html); w.document.close();
    }

    // Handle postMessage from details window
    window.addEventListener('message', (ev)=>{
      const d = ev.data; if(d && d.cmd==='update'){
        const order = orders.find(o=>o.id===d.id); if(order) updateStatus(order,d.status);
      }
    });

    async function updateStatus(order,newStatus){
      // Try to call API to update
      try{
        const res = await fetch(API_BASE, {method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({action:'update',id:order.id,status:newStatus})});
        if(res.ok){ const resp = await res.json(); if(resp.success){ order.status=newStatus; persistLocal(); renderOrders(); return } }
      }catch(e){console.warn('API update failed, fallback to local', e)}
      // fallback to local: update in localStorage
      order.status = newStatus; persistLocal(); renderOrders();
    }

    function persistLocal(){ localStorage.setItem('jetem_admin_orders', JSON.stringify(orders)); }

    // Listen for incoming client orders via simple polling (for demo) — real implementation: API push or websocket
    setInterval(async ()=>{
      try{
        const res = await fetch(API_BASE + '?action=newcount'); if(res.ok){ const j = await res.json(); if(j && j.newOrders){ /* можно подсветить UI */ } }
      }catch(e){}
    }, 15000);

  </script>
</body>
</html>
